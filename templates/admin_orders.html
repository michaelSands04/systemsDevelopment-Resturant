{% extends "base.html" %}
{% block content %}

<div class="mb-4">
  <h1 class="mb-1">Admin: Orders</h1>
  <p class="text-muted mb-0">Manage latest orders (status updates are audited in Firestore).</p>
</div>

{% if not orders or orders|length == 0 %}
  <div class="alert alert-info glass">
    No orders have been placed yet.
  </div>
{% else %}

  {% for o in orders %}
    <div class="card mb-3 shadow-sm">
      <div class="card-body">

        <div class="d-flex justify-content-between align-items-start gap-3">
          <div>
            <h5 class="mb-1">Order #{{ o.id }} — {{ o.username }}</h5>
            <div class="text-white-50 small">{{ o.created_at }}</div>
          </div>

          <form method="post" action="/admin/orders/{{ o.id }}/status" class="d-flex align-items-center gap-2">
            {# If you enabled Flask-WTF CSRF and exposed csrf_token(), this keeps POST working #}
            {% if csrf_token is defined %}
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            {% endif %}

            <select name="status" class="form-select form-select-sm w-auto">
              {% set s = (o.status or "")|lower %}
              <option value="pending"   {% if s == "pending" %}selected{% endif %}>pending</option>
              <option value="preparing" {% if s == "preparing" %}selected{% endif %}>preparing</option>
              <option value="completed" {% if s == "completed" %}selected{% endif %}>completed</option>
              <option value="cancelled" {% if s == "cancelled" %}selected{% endif %}>cancelled</option>
            </select>

            <button class="btn btn-sm btn-primary" type="submit">Update</button>
          </form>
        </div>

        <hr class="border-white border-opacity-10">

        <ul class="mb-2">
          {% for it in items_by_order.get(o.id, []) %}
            <li>{{ it.qty }} × {{ it.name }} (£{{ "%.2f"|format(it.unit_price) }})</li>
          {% endfor %}
        </ul>

        <div class="fw-bold">
          Total: £{{ "%.2f"|format(o.total_price) }}
        </div>

      </div>
    </div>
  {% endfor %}

{% endif %}

{% endblock %}
