{% extends "base.html" %}
{% block content %}

  <div class="mb-4">
    <h1 class="mb-1">Menu</h1>
    <p class="text-muted mb-0">Browse items stored in Cloud SQL. Ratings are aggregated in Firestore.</p>
  </div>

  {# category order + display names #}
  {% set cat_order = ["burger", "pizza", "sides", "drink", "other"] %}
  {% set cat_labels = {
    "burger": "Burgers",
    "pizza": "Pizza",
    "sides": "Sides",
    "drink": "Drinks",
    "other": "Other"
  } %}

  {# build a grouped dict: {category: [items]} #}
  {% set grouped = {} %}
  {% for item in menu %}
    {% set c = (item.category or "other")|lower %}
    {% if c not in grouped %}
      {% set _ = grouped.update({c: []}) %}
    {% endif %}
    {% set _ = grouped[c].append(item) %}
  {% endfor %}

  {% for c in cat_order %}
    {% if grouped.get(c) %}
      <div class="d-flex align-items-center justify-content-between mt-4 mb-2">
        <h3 class="mb-0">{{ cat_labels.get(c, c|title) }}</h3>
      </div>

      <div class="row g-3">
        {% for item in grouped.get(c, []) %}
          <div class="col-md-4">
            <div class="card h-100 shadow-sm">

              {% if item.image_url %}
                <img
                  src="{{ item.image_url }}"
                  class="card-img-top"
                  alt="{{ item.name }}"
                  style="height: 180px; object-fit: cover;"
                  loading="lazy"
                >
              {% else %}
                <div class="bg-secondary" style="height:180px;"></div>
              {% endif %}

              <div class="card-body d-flex flex-column">

                <div class="d-flex justify-content-between align-items-start">
                  <h5 class="card-title mb-1">{{ item.name }}</h5>

                  {% if item.review_count and item.review_count > 0 %}
                    <span class="badge bg-info text-dark">
                      ★ {{ item.avg_rating }}/5 ({{ item.review_count }})
                    </span>
                  {% else %}
                    <span class="badge bg-secondary">No ratings</span>
                  {% endif %}
                </div>

                <p class="card-text text-muted mb-3">{{ item.description }}</p>

                <div class="mt-auto d-flex justify-content-between align-items-center">
                  <span class="fw-bold">£{{ "%.2f"|format(item.price) }}</span>

                  <form method="post" action="/cart/add/{{ item.id }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                    <button class="btn btn-success" type="submit">Add to cart</button>
                
                  </form>
                </div>

              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endfor %}

{% endblock %}
